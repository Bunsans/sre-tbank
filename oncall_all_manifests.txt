---
apiVersion: v1
kind: ConfigMap
metadata:
  name: oncall
data:
  oncall.conf: |
    ---
    server:
      host: 0.0.0.0
      port: 8080
    debug: True
    oncall_host: oncall.$KUBE_NS.ingress.sre-ab.ru
    metrics: 
      prometheus:
        oncall-notifier:
          server_port: 8080
    db:
      conn:
        kwargs:
          scheme: mysql+pymysql
          user: root
          password: '1234'
          host: oncall-mysql
          port: 3306
          database: oncall
          charset: utf8
          echo: True
        str: "%(scheme)s://%(user)s:%(password)s@%(host)s/%(database)s?charset=%(charset)s"
      kwargs:
        pool_recycle: 3600
    session:
      encrypt_key: 'abc'
      sign_key: '123'
    auth:
      debug: False
      module: 'oncall.auth.modules.debug'
    notifier:
      skipsend: True
    healthcheck_path: /tmp/status
    messengers:
      - type: dummy
        application: oncall
        iris_api_key: magic

    allow_origins_list:
     - http://oncall.$KUBE_NS.ingress.sre-ab.ru

    supported_timezones:
      - 'US/Pacific'
      - 'US/Eastern'
      - 'US/Central'
      - 'US/Mountain'
      - 'US/Alaska'
      - 'US/Hawaii'
      - 'Asia/Kolkata'
      - 'Asia/Shanghai'
      - 'UTC'

    index_content_setting:
    #footer: |
    #  <ul>
    #    <li>Oncall © LinkedIn 2020</li>
    #    <li>Feedback</li>
    #    <li><a href="http://oncall.tools" target="_blank">About</a></li>
    #  </ul>
      missing_number_note: 'No number'

    notifications:
      default_roles:
        - "primary"
        - "secondary"
        - "shadow"
        - "manager"
      default_times:
        - 86400
        - 604800
      default_modes:
        - "email"

    reminder:
      activated: True
      polling_interval: 360
      default_timezone: 'US/Pacific'

    user_validator:
      activated: True
      subject: 'Warning: Missing phone number in Oncall'
      body: 'You are scheduled for an on-call shift in the future, but have no phone number recorded. Please update your information in Oncall.'

    slack_instance: foobar
    header_color: '#3a3a3a'
    team_managed_message: 'Managed team - this team is managed via API'

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: oncall
  labels:
    app.kubernetes.io/name: oncall
    app.kubernetes.io/component: web
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: oncall
      app.kubernetes.io/component: web
  template:
    metadata:
      annotations:
        sage/group: "ab1_kim"
      labels:
        app.kubernetes.io/name: oncall
        app.kubernetes.io/component: web
    spec:
      containers:
        - name: vector
          image: timberio/vector:0.37.1-alpine
          args:
            - "--config"
            - "/etc/vector/vector.toml"
          env:
            - name: VECTOR_SELF_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          volumeMounts:
            - name: varlog
              mountPath: /var/log
            - name: vector-config
              mountPath: /etc/vector
              readOnly: true
            - name: nginx-logs
              mountPath: /home/oncall/var/log/nginx
            - name: uwsgi-logs
              mountPath: /home/oncall/var/log/uwsgi
        - name: oncall
          image: knucksie/sre-ab-oncall:0.3
          env:
            - name: DOCKER_DB_BOOTSTRAP
              value: "1"
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
            - containerPort: 8888 # Порт метрик

          livenessProbe:
            httpGet:
              path: /healthcheck
              port: 8080
            failureThreshold: 1
            initialDelaySeconds: 15
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthcheck
              port: 8080
            failureThreshold: 1
            initialDelaySeconds: 15
            periodSeconds: 10
          startupProbe:
            httpGet:
              path: /healthcheck
              port: 8080
            failureThreshold: 10
            initialDelaySeconds: 30
            periodSeconds: 10
          resources:
            requests:
              cpu: 150m
              memory: 256Mi
            limits:
              cpu: 300m
              memory: 512Mi
          volumeMounts:
            - name: oncall-config
              mountPath: /home/oncall/config/config.yaml
              subPath: oncall.conf
              readOnly: true
            - name: nginx-logs
              mountPath: /home/oncall/var/log/nginx
            - name: uwsgi-logs
              mountPath: /home/oncall/var/log/uwsgi
      volumes:
        - name: oncall-config
          configMap:
            name: oncall
        - name: vector-config
          configMap:
            name: vector-config
        - name: varlog
          hostPath:
            path: /var/log
        - name: nginx-logs
          emptyDir: {}
        - name: uwsgi-logs
          emptyDir: {}

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: oncall-ingress
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
spec:
  ingressClassName: nginx
  rules:
    - host: oncall.$KUBE_NS.ingress.sre-ab.ru
      http:
        paths:
          - path: "/"
            pathType: Prefix
            backend:
              service:
                name: oncall
                port:
                  number: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: oncall
  annotations:
    prometheus.io/path: /metrics # <— path, по которому целевой под отдает метрики
    prometheus.io/port: "8888" # <— порт, соответствующий targetPort'у сервиса, с которого будут собираться метрики
    prometheus.io/scrape: "true"
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: oncall
  sessionAffinity: None
  ports:
    - name: main
      protocol: TCP
      port: 8080
      targetPort: 8080
    - name: metrics
      protocol: TCP
      port: 8888
      targetPort: 8888
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-config
data:
  vector.toml: |
    [log_schema]
    enabled = true

    [sources.oncall_logs]
    type = "file"
    include = ["/home/oncall/var/log/nginx/*.log"]
    read_from = "beginning"
    max_read_bytes = 10485760

    [transforms.enrich]
    type = "remap"
    inputs = ["oncall_logs"]
    source = '''
     .message, err = to_string(.message)

    .env = "dev"
    .system = "oncall"

    .inst = .kubernetes.pod_name

    .timestamp = now()
    
    .level = "info"
    '''

    [sinks.console]
    type = "console"
    inputs = ["enrich"]
    target = "stdout"
    encoding.codec = "json"
---
apiVersion: v1
kind: Secret
metadata:
  name: mysql
type: Opaque
data:
  MYSQL_ROOT_PASSWORD: MTIzNA==


---
apiVersion: v1
kind: Service
metadata:
  name: oncall-mysql
  labels:
    app: mysql
    app.kubernetes.io/name: mysql
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9104"
    prometheus.io/path: "/metrics"
spec:
  ports:
    - name: mysql
      port: 3306
      targetPort: 3306
    - name: metrics
      port: 9104
      targetPort: 9104
  clusterIP: None
  selector:
    app: mysql
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
spec:
  selector:
    matchLabels:
      app: mysql
      app.kubernetes.io/name: mysql
  serviceName: mysql
  replicas: 1
  template:
    metadata:
      labels:
        app: mysql
        app.kubernetes.io/name: mysql
    spec:
      initContainers:
      - name: generate-mycnf
        image: busybox:1.36
        envFrom:
          - secretRef:
              name: mysql
        command:
          - sh
          - -c
          - |
            set -eu
            umask 077
            mkdir -p /config
            cat > /config/my.cnf <<'EOF'
            [client]
            user=root
            password=${MYSQL_ROOT_PASSWORD}
            host=127.0.0.1
            port=3306
            EOF
            sed -i "s|\${MYSQL_ROOT_PASSWORD}|${MYSQL_ROOT_PASSWORD}|g" /config/my.cnf
            chown 65534:65534 /config/my.cnf
            chmod 0400 /config/my.cnf
        volumeMounts:
          - name: exporter-config
            mountPath: /config
      containers:
        - name: mysql
          image: mysql:8.3.0
          envFrom:
            - secretRef:
                name: mysql
          ports:
            - name: mysql
              containerPort: 3306
          volumeMounts:
            - name: data
              mountPath: /var/lib/mysql
              subPath: mysql
          resources:
            requests:
              cpu: 250m
              memory: 256Mi
          livenessProbe:
            tcpSocket:
              port: 3306
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            tcpSocket:
              port: 3306
            initialDelaySeconds: 5
            periodSeconds: 2
            timeoutSeconds: 1
        - name: mysql-exporter
          image: prom/mysqld-exporter:v0.15.1
          args:
            - "--config.my-cnf=/etc/mysql-exporter/my.cnf"
          ports:
            - name: metrics
              containerPort: 9104
          resources:
            requests:
              cpu: 100m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          volumeMounts:
            - name: exporter-config
              mountPath: /etc/mysql-exporter
              readOnly: true
          livenessProbe:
            httpGet:
              path: /metrics
              port: 9104
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /metrics
              port: 9104
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 3
      volumes:
        - name: data
          emptyDir: {}
        - name: exporter-config
          emptyDir: {}
